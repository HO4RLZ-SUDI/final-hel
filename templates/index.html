<!DOCTYPE html>
<html>
<head>
    <title>CyberGuard PRO</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
</head>
<body>
    <div class="hud-title">>> CYBERGUARD_OS // BIOMETRIC_MONITOR</div>
    
    <div class="main-layout">
        <div id="video-wrapper">
            <div id="webcam-container"></div>
            <canvas id="overlay"></canvas>
        </div>

        <div class="side-panel">
            <div class="card">
                <h3>SUBJECT IDENTIFICATION</h3>
                <div id="user-id">WAITING...</div>
                <div id="label-container"></div>
            </div>

            <div class="card">
                <h3>ENROLLMENT</h3>
                <input type="text" id="reg-name" placeholder="ENTER SUBJECT NAME">
                <button onclick="registerFace()">ENROLL</button>
            </div>
        </div>
    </div>

    <script>
        // เปลี่ยนเป็น URL โมเดลของคุณ
        const URL = "https://teachablemachine.withgoogle.com/models/M8Wb2awFk/"; 

        let model, faceNet, webcam, currentStatus = "No_Helmet", isLocked = false;

        async function init() {
            model = await tmImage.load(URL + "model.json", URL + "metadata.json");
            faceNet = await blazeface.load();
            
            const size = 500;
            webcam = new tmImage.Webcam(size, size, true);
            await webcam.setup();
            await webcam.play();
            
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            const canvas = document.getElementById("overlay");
            canvas.width = size; canvas.height = size;

            window.requestAnimationFrame(loop);
        }

        async function loop() {
            webcam.update();
            await predict();
            await draw();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const pred = await model.predict(webcam.canvas);
            let topProb = 0;
            for (let i = 0; i < pred.length; i++) {
                if(pred[i].probability > topProb) {
                    topProb = pred[i].probability;
                    currentStatus = pred[i].className;
                }
            }

            if (topProb > 0.95 && !isLocked) {
                isLocked = true;
                const img = webcam.canvas.toDataURL('image/jpeg', 0.4);
                fetch('/verify_event', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image: img, status: currentStatus})
                }).then(r => r.json()).then(d => {
                    document.getElementById("user-id").innerHTML = "ID: " + d.name;
                    setTimeout(() => isLocked = false, 5000); // เว้นช่วง 5 วิ
                });
            }
        }

        async function draw() {
            const canvas = document.getElementById("overlay");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, 500, 500);
            const faces = await faceNet.estimateFaces(webcam.canvas, false);
            if (faces.length > 0) {
                const face = faces[0];
                const color = currentStatus === "Helmet_OK" ? "#00f2ff" : "#ff3e3e";
                ctx.strokeStyle = color; ctx.lineWidth = 4;
                const size = [face.bottomRight[0]-face.topLeft[0], face.bottomRight[1]-face.topLeft[1]];
                ctx.strokeRect(face.topLeft[0], face.topLeft[1], size[0], size[1]);
                ctx.fillStyle = color;
                ctx.font = "bold 16px monospace";
                ctx.fillText(currentStatus, face.topLeft[0], face.topLeft[1]-10);
            }
        }

        async function registerFace() {
            const name = document.getElementById("reg-name").value;
            if(!name) return alert("Please enter name");
            const img = webcam.canvas.toDataURL('image/jpeg', 0.8);
            await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name, image: img})
            });
            alert("Subject Enrolled!");
            document.getElementById("reg-name").value = "";
        }
        init();
    </script>
</body>
</html>